# 本地音乐扫描功能 - 架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  MyFragment (个人中心)                                            │
│       │                                                           │
│       │ 点击"扫描本地"按钮                                          │
│       ▼                                                           │
│  LocalScanActivity (扫描界面)                                     │
│       ├── 权限检查/请求                                            │
│       ├── 进度显示                                                 │
│       ├── RecyclerView (LocalMusicAdapter)                        │
│       └── 操作按钮 (全选/取消/添加)                                │
│                                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        │ 调用
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  LocalMusicScanner (扫描工具类)                                   │
│       ├── scanLocalMusic()     - 扫描所有音乐                     │
│       ├── extractMetadata()    - 提取详细元数据                   │
│       ├── extractAlbumArt()    - 提取专辑封面                     │
│       └── formatDuration()     - 格式化时长                       │
│                                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        │ 使用
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Android系统层                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  MediaStore API                                                   │
│       └── ContentResolver.query()                                 │
│                                                                   │
│  MediaMetadataRetriever                                           │
│       ├── extractMetadata()                                       │
│       └── getEmbeddedPicture()                                    │
│                                                                   │
│  权限系统                                                          │
│       ├── READ_MEDIA_AUDIO (API 33+)                             │
│       └── READ_EXTERNAL_STORAGE (API < 33)                       │
│                                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        │ 读取
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        设备存储                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  /storage/emulated/0/Music/                                       │
│  /storage/emulated/0/Download/                                    │
│  其他音乐目录...                                                   │
│                                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        │ 持久化
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据持久层                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  MusicDao                                                         │
│       ├── addMusic()          - 添加到音乐库                      │
│       └── getMusicById()      - 查询音乐                          │
│                                                                   │
│  PlayMusicDao                                                     │
│       └── addToPlaylist()     - 添加到播放队列                    │
│                                                                   │
│  数据库表:                                                         │
│       ├── d_music             - 音乐库                            │
│       └── d_music_play        - 用户播放队列                      │
│                                                                   │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        │ 播放
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        播放器层                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  MusicPlayerManager                                               │
│       └── ExoPlayer                                               │
│                                                                   │
│  UserManageActivity                                               │
│       └── 播放控制界面                                             │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
用户操作
   │
   ├─→ [1] 点击"扫描本地"
   │        │
   │        ▼
   │   检查权限
   │        │
   │        ├─→ 权限已授予 ─→ 继续
   │        └─→ 权限未授予 ─→ 请求权限 ─→ 用户确认 ─→ 继续
   │
   ├─→ [2] 开始扫描
   │        │
   │        ▼
   │   后台线程 (ExecutorService)
   │        │
   │        ├─→ ContentResolver.query()
   │        │        │
   │        │        └─→ MediaStore.Audio.Media
   │        │                 │
   │        │                 └─→ 返回Cursor
   │        │
   │        ├─→ 遍历Cursor
   │        │        │
   │        │        └─→ 提取: ID, 标题, 艺术家, 路径, 时长
   │        │
   │        └─→ 创建MusicBean列表
   │                 │
   │                 ▼
   │            主线程更新UI
   │                 │
   │                 └─→ RecyclerView显示结果
   │
   ├─→ [3] 选择音乐
   │        │
   │        ├─→ 点击条目 ─→ 切换选中状态
   │        ├─→ 点击全选 ─→ 全部选中
   │        └─→ 点击取消全选 ─→ 清空选择
   │
   └─→ [4] 添加到播放列表
            │
            ▼
       后台线程处理
            │
            ├─→ 遍历选中的音乐
            │        │
            │        ├─→ 检查是否存在 (MusicDao.getMusicById)
            │        │        │
            │        │        ├─→ 不存在 ─→ 添加到d_music表
            │        │        └─→ 已存在 ─→ 跳过
            │        │
            │        └─→ 添加到d_music_play表
            │                 │
            │                 └─→ PlayMusicDao.addToPlaylist()
            │
            └─→ 主线程显示结果
                     │
                     ├─→ Toast提示
                     └─→ 清空选择
```

## 线程模型

```
┌──────────────────────┐
│      主线程           │
│   (Main Thread)      │
├──────────────────────┤
│                      │
│ • UI初始化           │
│ • 按钮点击监听       │
│ • 显示进度条         │
│ • 更新RecyclerView   │
│ • 显示Toast          │
│                      │
└──────────┬───────────┘
           │
           │ Handler.post()
           │
┌──────────▼───────────┐
│      后台线程         │
│  (ExecutorService)   │
├──────────────────────┤
│                      │
│ • 扫描音乐文件       │
│ • 提取元数据         │
│ • 数据库操作         │
│ • 文件I/O            │
│                      │
└──────────────────────┘
```

## 类关系图

```
┌──────────────────────┐
│    MyFragment        │
│  (个人中心页面)       │
└──────────┬───────────┘
           │ startActivity()
           │
           ▼
┌──────────────────────┐         ┌──────────────────────┐
│  LocalScanActivity   │◄────────│  LocalMusicAdapter   │
│   (扫描界面)          │ uses    │   (列表适配器)        │
└──────────┬───────────┘         └──────────────────────┘
           │
           │ uses
           │
┌──────────▼───────────┐
│  LocalMusicScanner   │
│   (扫描工具类)        │
└──────────┬───────────┘
           │
           │ uses
           │
┌──────────▼───────────┐         ┌──────────────────────┐
│     MusicDao         │         │   PlayMusicDao       │
│   (音乐库DAO)         │         │   (播放列表DAO)       │
└──────────────────────┘         └──────────────────────┘
           │                                │
           └────────────┬───────────────────┘
                        │
                        │ operates on
                        │
           ┌────────────▼──────────────┐
           │      SQLite Database      │
           │  ┌─────────────────────┐  │
           │  │  d_music (音乐库)   │  │
           │  └─────────────────────┘  │
           │  ┌─────────────────────┐  │
           │  │ d_music_play (队列) │  │
           │  └─────────────────────┘  │
           └───────────────────────────┘
```

## 权限处理流程

```
                开始
                 │
                 ▼
         ┌──────────────┐
         │ 检查Android版本│
         └───────┬────────┘
                 │
      ┌──────────┴──────────┐
      │                     │
      ▼                     ▼
 API 33+                API < 33
      │                     │
      ▼                     ▼
READ_MEDIA_AUDIO    READ_EXTERNAL_STORAGE
      │                     │
      └──────────┬──────────┘
                 │
                 ▼
         ┌──────────────┐
         │  检查权限状态  │
         └───────┬────────┘
                 │
      ┌──────────┴──────────┐
      │                     │
      ▼                     ▼
   已授予                  未授予
      │                     │
      ▼                     ▼
   继续扫描            请求权限
                            │
                 ┌──────────┴──────────┐
                 │                     │
                 ▼                     ▼
             用户允许              用户拒绝
                 │                     │
                 ▼                     ▼
             继续扫描            显示提示消息
```

## 关键设计决策

### 1. 为什么使用MediaStore而非文件遍历？
- **性能**: MediaStore已建立索引，查询速度快
- **兼容性**: 适配Android 10+的分区存储
- **完整性**: 自动处理不同存储位置

### 2. 为什么使用ExecutorService？
- **单线程**: 保证扫描操作顺序执行
- **易管理**: 统一的线程池管理
- **可控**: 可以优雅地关闭线程

### 3. 为什么同时操作两个数据库表？
- **d_music**: 全局音乐库，所有用户共享
- **d_music_play**: 用户播放队列，个人化

### 4. 为什么过滤30秒以下的音频？
- 排除系统提示音
- 排除通知铃声
- 提高扫描质量

## 性能优化

### 扫描优化
```java
// 使用MediaStore的索引
String selection = MediaStore.Audio.Media.IS_MUSIC + " != 0 AND " +
                  MediaStore.Audio.Media.DURATION + " > 30000";

// 只查询需要的列
String[] projection = {
    MediaStore.Audio.Media._ID,
    MediaStore.Audio.Media.TITLE,
    // ... 其他必要字段
};
```

### UI优化
```java
// 后台线程处理数据
executorService.execute(() -> {
    List<MusicBean> result = scanMusic();
    
    // 主线程更新UI
    mainHandler.post(() -> {
        updateUI(result);
    });
});
```

### 数据库优化
```java
// 批量插入时使用事务
// 检查重复时使用索引查询
```

## 扩展性设计

### 支持新的音频格式
在 `LocalMusicScanner` 中修改查询条件：
```java
String selection = MediaStore.Audio.Media.IS_MUSIC + " != 0";
// MediaStore会自动识别系统支持的所有音频格式
```

### 支持专辑封面显示
```java
// 已实现提取方法
String albumArt = LocalMusicScanner.extractAlbumArt(path);
// 在Adapter中解码并显示
```

### 支持增量扫描
```java
// 添加时间戳字段
long lastScanTime = getLastScanTime();
String selection = MediaStore.Audio.Media.DATE_ADDED + " > ?";
String[] args = {String.valueOf(lastScanTime)};
```

## 安全性考虑

### 权限
- 严格遵循Android权限模型
- 只请求必要的权限
- 处理权限被拒绝的情况

### 数据验证
- 检查文件路径有效性
- 验证元数据完整性
- 处理异常情况

### 用户隐私
- 不上传音乐文件信息
- 不修改原始文件
- 本地处理所有数据
