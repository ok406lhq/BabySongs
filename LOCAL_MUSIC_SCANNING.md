# 本地音乐扫描功能说明

## 功能概述

本地音乐扫描功能允许用户扫描Android设备中的MP3音乐文件，并将它们添加到应用的播放列表中。这使得用户可以播放存储在设备上的本地音乐，而不仅仅是应用预置的音乐。

## 主要特性

### 1. 权限处理
- **Android 13+ (API 33+)**: 使用 `READ_MEDIA_AUDIO` 权限
- **Android 12 及以下**: 使用 `READ_EXTERNAL_STORAGE` 权限
- 自动根据Android版本请求合适的权限
- 友好的权限请求提示

### 2. 智能扫描
- 使用 `MediaStore` API 高效扫描设备音乐
- 自动过滤短音频（时长 < 30秒），避免扫描到提示音等非音乐文件
- 支持提取完整的音乐元数据：
  - 歌曲标题
  - 艺术家/歌手
  - 文件路径
  - 时长
  - 专辑封面（可选）

### 3. 用户界面
- **入口**: 用户个人中心页面的"扫描本地"按钮
- **扫描界面**提供：
  - 扫描进度显示
  - 扫描结果列表
  - 多选功能（复选框）
  - 全选/取消全选按钮
  - 选中数量实时显示
  - 添加到播放列表按钮

### 4. 播放列表集成
- 将扫描到的音乐添加到 `d_music` 表（音乐库）
- 同时添加到 `d_music_play` 表（用户播放队列）
- 自动检测重复歌曲，避免重复添加
- 支持 ExoPlayer 直接播放本地文件

## 使用方法

### 用户操作流程

1. **打开扫描页面**
   - 进入应用的"我的"页面
   - 点击"扫描本地"按钮

2. **授予权限**（首次使用）
   - 系统会弹出权限请求对话框
   - 点击"允许"授予音频文件访问权限

3. **扫描音乐**
   - 应用自动开始扫描设备中的音乐文件
   - 显示扫描进度
   - 扫描完成后显示找到的音乐列表

4. **选择音乐**
   - 点击音乐条目选中/取消选中
   - 使用"全选"按钮快速选择所有音乐
   - 使用"取消全选"清除所有选择
   - 查看当前选中的音乐数量

5. **添加到播放列表**
   - 点击底部的"添加选中的音乐到播放列表"按钮
   - 等待处理完成
   - 显示成功添加的音乐数量

6. **播放音乐**
   - 返回首页或音乐列表
   - 新添加的本地音乐会出现在播放列表中
   - 可以像播放其他音乐一样播放本地音乐

## 技术实现

### 核心类

#### 1. `LocalMusicScanner`
音乐扫描工具类，负责：
- 使用 `MediaStore` 查询音频文件
- 使用 `MediaMetadataRetriever` 提取详细元数据
- 提取专辑封面图片（Base64编码）
- 格式化音乐时长

```java
// 扫描所有本地音乐
List<MusicBean> musicList = LocalMusicScanner.scanLocalMusic(context);

// 提取单个文件的详细元数据
MusicBean music = LocalMusicScanner.extractMetadata(filePath);

// 提取专辑封面
String albumArt = LocalMusicScanner.extractAlbumArt(filePath);
```

#### 2. `LocalScanActivity`
扫描界面Activity，负责：
- 权限检查和请求
- 显示扫描进度
- 展示扫描结果
- 处理用户选择
- 添加音乐到数据库

#### 3. `LocalMusicAdapter`
RecyclerView适配器，负责：
- 显示扫描到的音乐列表
- 处理多选逻辑
- 管理选中状态

### 数据库集成

#### 音乐库表 (d_music)
存储所有音乐的基本信息：
```sql
INSERT INTO d_music (id, name, singer, img, path, genre_id, create_time)
VALUES (?, ?, ?, ?, ?, ?, ?);
```

#### 播放队列表 (d_music_play)
存储用户的播放列表：
```sql
INSERT OR REPLACE INTO d_music_play (id, user_id, sta)
VALUES (?, ?, '0');
```

### 线程模型
- **扫描操作**: 在后台线程执行（ExecutorService）
- **UI更新**: 通过Handler发送到主线程
- **数据库操作**: 在后台线程执行，避免阻塞UI

## 兼容性

### Android版本
- **最低版本**: Android 8.1 (API 27)
- **目标版本**: Android 14 (API 34)
- **权限适配**: 完整支持Android 13的新权限模型

### 音频格式
当前主要支持MP3格式，但 MediaStore 会返回设备上所有被识别为音乐的文件，包括：
- MP3
- AAC
- FLAC
- WAV
- OGG
等格式

### ExoPlayer兼容性
所有扫描到的本地音乐文件都可以被 ExoPlayer 播放，因为使用的是本地文件路径：
```java
MediaItem mediaItem = MediaItem.fromUri(localFilePath);
```

## 注意事项

### 权限
- 应用需要用户明确授予存储/音频访问权限
- 如果权限被拒绝，功能将无法使用
- 建议在权限被拒绝时提供友好的提示

### 性能
- 扫描大量音乐文件可能需要一些时间
- 扫描操作在后台线程进行，不会阻塞UI
- 建议设备上音乐文件数量在合理范围内

### 存储
- 扫描到的音乐信息会持久化到SQLite数据库
- 音乐文件本身不会被复制或移动
- 如果原始音乐文件被删除或移动，播放时会出错

### 重复处理
- 通过音乐ID检测重复
- 重复的音乐不会被再次添加到音乐库
- 但会确保添加到当前用户的播放列表

## 未来改进方向

1. **专辑封面显示**
   - 在列表中显示提取的专辑封面
   - 支持从网络下载缺失的封面

2. **智能分类**
   - 根据流派自动分类
   - 支持按艺术家、专辑分组显示

3. **增量扫描**
   - 记录上次扫描时间
   - 只扫描新增的音乐文件

4. **播放历史**
   - 记录本地音乐的播放次数
   - 生成个人喜好推荐

5. **歌词支持**
   - 扫描LRC歌词文件
   - 显示滚动歌词

## 问题排查

### 找不到音乐文件
1. 检查音乐文件是否存在于设备的音乐目录
2. 确认文件格式是否被系统识别为音乐
3. 尝试使用系统文件管理器查看文件

### 权限被拒绝
1. 进入系统设置 -> 应用 -> BabySongs
2. 找到"权限"选项
3. 手动开启"音乐和音频"或"存储"权限

### 添加后无法播放
1. 确认原始音乐文件未被删除或移动
2. 检查文件格式是否被ExoPlayer支持
3. 确认文件路径正确且可访问

## 开发者信息

### 相关文件
- `LocalMusicScanner.java` - 扫描工具类
- `LocalScanActivity.java` - 扫描界面
- `LocalMusicAdapter.java` - 列表适配器
- `activity_local_scan.xml` - 界面布局
- `item_local_music.xml` - 列表项布局
- `MyFragment.java` - 入口修改

### API使用
- `MediaStore.Audio.Media` - 音频文件查询
- `ContentResolver` - 内容解析器
- `MediaMetadataRetriever` - 元数据提取
- `ExecutorService` - 后台线程管理
- `Handler` - 主线程消息处理

### 数据流
```
用户点击"扫描本地" 
  -> 检查权限 
  -> 后台扫描音乐 
  -> 显示结果列表 
  -> 用户选择音乐 
  -> 添加到数据库 
  -> 添加到播放队列 
  -> 可以播放
```
